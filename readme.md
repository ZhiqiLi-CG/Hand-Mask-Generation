# Hand Mask Generation and Validation Tool

These codes are used to remove hand information for VirtualCube.  Thus it required the file organised as the VirtualCube project requires.

## HandMaskTool.py
Tranverse the dataset folder and then generate the hand mask for each image.
TransverFolder.py can be controled by command args and setting file and information from command args and setting file is handled by the module setting.py which is introduced in the second section.  Here I will give you some procedure to use TransverFolder.py easily and if you want to know how to set the command args and setting file by youself, please refer to setting.py in details. 

Generate setting file

```
python HandMaskTool.py --setting_format .\setting.xml --path \\msralab\ProjectData\IG_VirtualCube\ViewSynthesis\20220708Touch --video_path D: 
```


### Generate HandMask

Args input from command args
```
python HandMaskTool.py --setting .\setting.xml --mode "generate"
```

Args set by Setting.xml
```
python HandMaskTool.py --path \\msralab\ProjectData\IG_VirtualCube\ViewSynthesis\20220727Touch --mode "generate" --mask_camera "0,6,8" --validate_camera "1,5" --clips "7,8"
```
### Validate by Video

Args input from command args
```
python HandMaskTool.py --setting .\setting.xml --mode "validate"
```

Args set by Setting.xml
```
python HandMaskTool.py --path \\msralab\ProjectData\IG_VirtualCube\ViewSynthesis\20220727Touch --video_path D:\\VideoTest --mode "validate" --mask_camera "0,6,8" --validate_camera "1,5" --clips "7,8"
```




## setting.py
This file will generate hand masks for some of the datasets. Note that the storage structure for each dataset must be similar to the following example( Names of each hierarchy must follow the patterns and only the suffix of files, namely the image type for images, can change)
```
├───20220708101113
│   │   calib.yaml
│   │
│   ├───00_rgbd
│   │   │   bg.png
│   │   │   bg_depth.png
│   │   │
│   │   ├───clip0
│   │   │       000000_color.png
│   │   │       000000_depth.png

......
```
As mentioned before, TransverFolder.py use command args and setting file to control the behavior of itsel. Setting files describe the arguments for every dataset respectively, which is the local descriptor and command args describe the arguments for all datasets, which is the global descriptor.  Command Line args can substitude the content of setting files and also override the content of setting files, but if setting file exist, the local despcriptor from the setting file has the higher priority defaultly.

Following are the arguments that must be input from command lines.

-   --mode  : select the mode, "generate" or "validate". "generate" means generate hand mask for each frames and "validate" means validate hand masks generated by videos.
-   --prompt: whether output the prompt information, whose values is False or True and True is default.
-   --fps: Set the fps of the validation video.
- 	--thread: Set thow many processes are used in the program
-   --setting_format: generate a setting file based on the global description from the command line
-	--setting: use the local descriptor from the setting file and the setting file path follows "--setting"
-	--use_command: if the same item is occur in command lines and setting file at the same time, then the global descriptor from the command lines is used, rather than the local descriptor from the setting file.
-	--override: if the same item is occur in command lines and setting file at the same time, then the global descriptor from the command lines is used and content in the setting file will be overrided by the content from command lines.
-   --path  : the path of one dataset or one folder that contains all the dataset, if it is a floder contains several dataset, you could use the "dataset" in setting file to filter the datasets.
-   --dataset  : the path of one dataset or one folder that contains all the dataset, if it is a floder contains several dataset, you could use the "dataset" in setting file to filter the datasets.

Following are the arguments that may occur in the setting file and in command lines.  Note here the argument in the occuring in the setting file describe the setting for one dataset and that in command lines describe the setting for all dataset during this calling.

-   --video_path  : the path for the purpose of validattion if the mode is "validate".
-   --mask_camera : the list of all the cameras for which the hand_mask will be generated
-   --validate_camera : the list of all the cameras which is used to assist the generation of hand mask generation and to validate them.
-   --clips : the list contains all the clips for which the hand mask will be generated.

Following are the arguments that only occur in the setting file 

-	path: the path here is the path for a spedific dataset, different from the above path argument. 

**Note: If a command arg is list, use ""  around the value in case of unexpected error.**

### Setting File
The setting file has the following format and you could use ``--setting_format example_setting.xml`` to generate a setting file based on the input of the command line.

```xml
<?xml version="1.0" ?>
<Datasets>
	<Dataset>
		<mask_camera type="list" len="3">
			<elem index="0" type="int">0</elem>
			<elem index="1" type="int">6</elem>
			<elem index="2" type="int">8</elem>
		</mask_camera>
		<validate_camera type="list" len="3">
			<elem index="0" type="int">3</elem>
			<elem index="1" type="int">4</elem>
			<elem index="2" type="int">5</elem>
		</validate_camera>
		<clip_list type="list" len="2">
			<elem index="0" type="int">7</elem>
			<elem index="1" type="int">8</elem>
		</clip_list>
		<path type="str">\\msralab\ProjectData\IG_VirtualCube\ViewSynthesis\20220708Touch\20220708100059</path>
		<video_path type="str">D:</video_path>
	</Dataset>
	<Dataset>
		<mask_camera type="list" len="3">
			<elem index="0" type="int">0</elem>
			<elem index="1" type="int">6</elem>
			<elem index="2" type="int">8</elem>
		</mask_camera>
		<validate_camera type="list" len="3">
			<elem index="0" type="int">3</elem>
			<elem index="1" type="int">4</elem>
			<elem index="2" type="int">5</elem>
		</validate_camera>
		<clip_list type="list" len="2">
			<elem index="0" type="int">7</elem>
			<elem index="1" type="int">8</elem>
		</clip_list>
		<path type="str">\\msralab\ProjectData\IG_VirtualCube\ViewSynthesis\20220708Touch\20220708101113</path>
		<video_path type="str">D:</video_path>
	</Dataset>
	<Dataset>
		<mask_camera type="list" len="3">
			<elem index="0" type="int">0</elem>
			<elem index="1" type="int">6</elem>
			<elem index="2" type="int">8</elem>
		</mask_camera>
		<validate_camera type="list" len="3">
			<elem index="0" type="int">3</elem>
			<elem index="1" type="int">4</elem>
			<elem index="2" type="int">5</elem>
		</validate_camera>
		<clip_list type="list" len="2">
			<elem index="0" type="int">7</elem>
			<elem index="1" type="int">8</elem>
		</clip_list>
		<path type="str">\\msralab\ProjectData\IG_VirtualCube\ViewSynthesis\20220708Touch\20220708101837</path>
		<video_path type="str">D:</video_path>
	</Dataset>
</Datasets>


```



## Hand Segmentation Method

There are 3 methods to segment hand: color-based method, depth-based method and mixed method.

### color-based method

Color-based method only uses the RGB image to segment hand, using Mediapipe of Google and skeleton-based segmentation method[].  In this method, the first step is to detect the hand skeleton from RGB image using Mediapipe and the detected skeleton is used to generate the hand mask by the skeleton-based segmentation method.

To make the method adapt to our generation of training set. Images from other camera, called validation camera, assist the generation.  The primary rule is that the hand need to be segment only if the integral hand is not detected in images from all the validation camera

### depth-based method



### mixed method

Mix the color-based method and the depth-based method and the union of hand masks from them is used.
